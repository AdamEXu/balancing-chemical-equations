<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speedrunning Balancing Chemical Equations</title>
</head>
<body>
    <div style="text-align: center; padding: 20px;">
        <style>
            @keyframes rainbow {
                0% { color: red; }
                14% { color: orange; }
                28% { color: yellow; }
                42% { color: green; }
                56% { color: blue; }
                70% { color: indigo; }
                84% { color: violet; }
                100% { color: red; }
            }
            #title {
                animation: rainbow 10s infinite;
                text-shadow: 1px 1px 4px #000000;
                font-size: 48px !important;
            }
        </style>
        <h1 id="title">Speedrunning Balancing Chemical Equations</h1>
    </div>
    {% if user %}
    <div>
        <p>Welcome, {{ user.name }}! <a href="/logout">Logout?</a></p>
        <div>
            <style>
                @keyframes button-pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                    100% { transform: scale(1); }
                }
                button {
                    animation: button-pulse 2s infinite;
                    border: none;
                    background-color: blue;
                    color: white;
                    padding: 0;
                    text-align: center;
                    text-decoration: none;
                    display: inline-block;
                    font-family: serif;
                    margin: 20px;
                    cursor: pointer;
                    -webkit-tap-highlight-color: rgba(0,0,0,0);
                    -webkit-user-select: none;
                    user-select: none;
                }
                button:hover {
                    background-color: darkblue;
                }
                button:active {
                    transform: scale(0.95);
                }
            </style>
            <p style="width: 100%; text-align: center;"><button id="open-simulator-btn" style="font-size: 67px;">Open simulator</button></p>
        </div>
        <p><b>Category selection: </b><select type="select" name="run-type" id="run-type">
            <optgroup label="Classic">
                <option value="full">100% (full game)</option>
                <option value="easy">Easy (level 1)</option>
                <option value="medium">Medium (level 2)</option>
                <option value="hard">Hard (level 3)</option>
            </optgroup>
        </select></p>
    </div>
    {% else %}
    <div>
        <p><a href="/auth/google">Sign in with Google</a> (required to submit runs) (must be school email)</p>
    </div>
    {% endif %}
    <p>100% = full run, completing all 3 levels, Easy = complete level 1 only, Medium = complete level 2 only, Hard = complete level 3 only</p>
    <p>Time starts as soon as you select a level, and it ends once you finish the last level in your challenge (or the only level if you selected another category). You must get 5 stars on the level (no mistakes) in order for the timer to stop. The timer automatically submits your score to the leaderboard.</p>
    <div>
        <style>
            @keyframes bounce {
                0% { transform: translateY(0) scale(1.1) translateX(16px) scaleX(1.2) rotate(10deg); }
                50% { transform: translateY(-10px) scale(1.1) translateX(16px) scaleX(1.2) rotate(10deg); }
                100% { transform: translateY(0) scale(1.1) translateX(16px) scaleX(1.2) rotate(10deg); }
            }

            img:hover {
                animation: bounce 0.5s;
                transform: scale(1.1) translateX(16px) scaleX(1.2) rotate(10deg);
            }
            a {
                -webkit-tap-highlight-color: rgba(0,0,0,0);
                -webkit-user-select: none;
                user-select: none;
            }
        </style>
        <a href="javascript:void(0);" id="music-toggle" style="cursor: pointer;"><img src="/static/hourglass.gif" alt="Speedrun Timer" width="100"/></a></div>
    <p>Click the above image to toggle music <b id="mus-status" style="color: red;">(music is currently off)</b></p>
    <!-- Leaderboards -->
    <h2 style="margin-top: 32px; margin-bottom: 0;">Leaderboards</h2>
    <div id="leaderboards" style="display: flex; flex-wrap: wrap; gap: 20px;">
        {% for run_type, board in leaderboards.items() %}
        <div>
            <h4>{{ board.label }}</h4>
            {% if board.entries %}
            <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse;">
                <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Time</th>
                    <th>Date/Time (Local)</th>
                </tr>
                {% for entry in board.entries %}
                <tr>
                    <td>{{ entry.rank }}</td>
                    <td>{{ entry.name }}</td>
                    <td>{{ entry.time }}</td>
                    <td class="date-time">{{ entry.date_time }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p><i>No runs yet</i></p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% if user %}
    <!-- your runs -->
    <h2 style="margin-bottom: 0; margin-top: 32px;">Your Runs</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        {% for run_type in run_types %}
        <div>
            <h4>{{ run_type_labels[run_type] }}</h4>
            {% if runs[run_type] %}
            <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse;">
                <tr>
                    <th>#</th>
                    <th>Time</th>
                    <th>Date/Time (Local)</th>
                </tr>
                {% for run in runs[run_type] %}
                <tr>
                    <td>{{ run.attempt }}</td>
                    <td>{{ run.time }}</td>
                    <td class="date-time">{{ run.date_time }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p><i>No runs yet</i></p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <h3>FAQ</h3>
    <p>
        <ul>
            <li>
                <b>How does the game work?</b> Balance the chemical equations idk you figure it out lol
            </li>
            <li>
                <b>How does timing work?</b> Time starts upon first level selection. Time stops upon reaching the 5 star screen for the last level. Must complete all three levels (5 stars). You may reset during the run (doesn't reset timer) but your time will only count if you finish all three levels.
            </li>
            <li>
                <b>Is this even legal?</b> Yep, the code is under creative commons license and the sim is open source. I just forked it and added this stuff. <a href="https://phet.colorado.edu/en/licensing/html" target="_blank">More info here.</a>
            </li>
            <li>
                <b>What score is shown?</b> Only your best time goes on the leaderboard.
            </li>
            <li>
                <b>I got a bad time, how to remove from leaderboard?</b> Here's the great thing, you don't. Just stop skill issuing and get a better time smh
            </li>
            <li>
                <b>How to get better?</b> Idk that's a you problem lmao
            </li>
            <li>
                <b>Why is the site ugly?</b> It's very 90s esque and it's really simple/usable. They really don't make sites like these anymore (also the site is under 256kb)
            </li>
            <li>
                <b>Can I remove my name from the leaderboard?</b> If you contact me (you probably know me irl) I can remove it for you. If you don't know who I am use one of the contact methods on my GitHub profile: <a href="https://github.com/AdamEXu" target="_blank">AdamEXu</a>.
            </li>
            <li>
                <b>When more categories?</b> Sometime in the future, maybe...
            </li>
        </ul>
    </p>
    <p>
        &copy;2026 Adam Xu - Open source on GitHub <a href="https://github.com/AdamEXu/balancing-chemical-equations" target="_blank">AdamEXu/balancing-chemical-equations</a> (would appreciate a star)
    </p>
    <p>
        Fork of <a href="https://phet.colorado.edu/en/simulation/balancing-chemical-equations" target="_blank">Balancing Chemical Equations</a> by PhET Interactive Simulations, University of Colorado Boulder (Github: <a href="https://github.com/phetsims/balancing-chemical-equations" target="_blank">phetsims/balancing-chemical-equations</a>), licensed under <a href="https://phet.colorado.edu/en/licensing/html" target="_blank">Creative Commons Attribution 4.0 International (CC BY 4.0)</a>.
    </p>
    <script>
        // Initialize music variables and functions FIRST
        var musicOn = false;
        var currentAudio = null;

        function toggleMusic() {
            musicOn = !musicOn;
            var statusEl = document.getElementById('mus-status');
            if (musicOn) {
                statusEl.textContent = '(music is currently on)';
                statusEl.style.color = 'green';
                playMusic();
            } else {
                statusEl.textContent = '(music is currently off)';
                statusEl.style.color = 'red';
                stopMusic();
            }
        }
        
        function playMusic() {
            if (!currentAudio) {
                currentAudio = new Audio('/static/load.mp3');
            }
            currentAudio.loop = true;
            currentAudio.volume = 1;
            currentAudio.play().catch(function(error) {
                console.log('Audio play failed:', error);
            });
        }

        function stopMusic() {
            if (currentAudio) {
                currentAudio.pause();
            }
        }

        function openSimulator() {
            var runType = document.getElementById('run-type').value;
            var url = '/game?run-type=' + runType + '&music=' + musicOn;
            
            // Map run-type to gameLevels query parameter
            var gameLevelsMap = {
                'full': '1,2,3',
                'easy': '1',
                'medium': '2',
                'hard': '3',
                'remix-full': '1,2,3',
                'remix-easy': '1',
                'remix-medium': '2',
                'remix-hard': '3'
            };
            
            if (gameLevelsMap[runType]) {
                url += '&gameLevels=' + gameLevelsMap[runType];
            }
            
            // Add remix flag for remix categories
            if (runType.startsWith('remix-')) {
                url += '&remix';
            }
            
            window.location.href = url;
        }

        // Add event listeners immediately - use both touch and click for Safari
        (function() {
            // Music toggle button
            var musicToggle = document.getElementById('music-toggle');
            if (musicToggle) {
                musicToggle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    toggleMusic();
                }, { passive: false });
                musicToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleMusic();
                });
            }

            // Open simulator button
            var openSimBtn = document.getElementById('open-simulator-btn');
            if (openSimBtn) {
                openSimBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    openSimulator();
                }, { passive: false });
                openSimBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openSimulator();
                });
            }
        })();

        // Apply gold background to first place rows (leaderboards only, not user's runs)
        var leaderboardSection = document.getElementById('leaderboards');
        if (leaderboardSection) {
            leaderboardSection.querySelectorAll('table tr').forEach(function(row) {
                var rankCell = row.querySelector('td:first-child');
                if (rankCell && rankCell.textContent.trim() === 'ðŸ¥‡') {
                    row.querySelectorAll('td').forEach(function(td) {
                        td.style.backgroundImage = 'url(/static/gold-bg.gif)';
                        td.style.backgroundSize = 'cover';
                        td.style.backgroundPosition = 'center';
                        td.style.fontWeight = 'bold';
                    });
                } else if (rankCell && rankCell.textContent.trim() === 'ðŸ¥ˆ') 
                {
                    row.querySelectorAll('td').forEach(function(td) {
                        td.style.backgroundImage = 'url(/static/silver.jpg)';
                        td.style.backgroundSize = 'cover';
                        td.style.backgroundPosition = 'center';
                    });
                }
            });
        }

        // convert all date-time elements to user's local timezone - do this LAST
        setTimeout(function() {
            document.querySelectorAll('.date-time').forEach(function(element) {
                try {
                    var dateText = element.textContent.trim();
                    if (dateText && dateText.length > 0) {
                        // iOS Safari requires ISO 8601 format - convert "YYYY-MM-DD HH:MM:SS" to "YYYY-MM-DDTHH:MM:SSZ"
                        var isoDate = dateText.replace(' ', 'T') + 'Z';
                        var date = new Date(isoDate);
                        if (date && !isNaN(date.getTime()) && isFinite(date.getTime())) {
                            var options = { 
                                year: 'numeric', 
                                month: '2-digit', 
                                day: '2-digit',
                                hour: '2-digit', 
                                minute: '2-digit', 
                                second: '2-digit',
                                hour12: true 
                            };
                            element.textContent = new Intl.DateTimeFormat('en-US', options).format(date);
                        }
                    }
                } catch (error) {
                    console.log('Date conversion error for element:', element.textContent, error);
                }
            });
        }, 100);
    </script>
</body>
</html>